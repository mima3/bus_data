<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="ja">
<head>
  <title>バス路線データ</title>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="js/jquery/jquery-ui.min.css" type="text/css" />
  <link rel="stylesheet" href="js/select2/select2.css" type="text/css" />
  <link rel="stylesheet" href="base.css" type="text/css" />
  <style type="text/css">
  #map {
  }

  .SvgOverlay {
  }

  .SvgOverlay svg {
    position: absolute;
    top: -4000px;
    left: -4000px;
    width: 8000px;
    height: 8000px;        
  }

  .SvgOverlay path {
    stroke: black;
    stroke-width: 1px;
    fill-opacity: .6;
  }
  </style>
  <script type="text/javascript" src="js/async/lib/async.js"></script>
  <script type="text/javascript" src="js/jquery/jquery-1.11.1.min.js"></script>
  <script type="text/javascript" src="js/jquery/jquery-ui-1.10.4.min.js"></script>
  <script type="text/javascript" src="js/d3/d3.min.js"></script>
  <script type="text/javascript" src="js/blockui/jquery.blockUI.js"></script>
  <script type="text/javascript" src="js/select2/select2.min.js"></script> 
  <script src="https://maps.googleapis.com/maps/api/js?v=3.exp"></script>
  <script type="text/javascript" src="js/util.js"></script>
</head>
<body>
  <div id="contents">
    <p>この画面は「<a href="http://micrms.force.com/top">路面管理の高度化における実証実験</a>」で提供されているデータを表示するものです。</p>
    <select id="selRoute">ルート表示</select>
    <button id="btn_show">路面表示</button>
    <div id="map" style="width: 900px; height: 600px"></div>
  </div>
<script type="text/javascript">
$(function() {
  /**
   * ローディング画面の表示
   */
  function showBlockUI() {
    $.blockUI(
      { 
        message: '<img src="img/loading.gif" />Loading...',
        css: { 
          border: 'none', 
          padding: '15px', 
          backgroundColor: '#444', 
          '-webkit-border-radius': '10px', 
          '-moz-border-radius': '10px', 
          opacity: .5, 
          color: '#fff' 
        } 
      }
    );
  }

  $(document).ready(function() {
    var latlng = new google.maps.LatLng(35.02231309126647,135.9622116936153);
    var opts = {
      zoom: 13,
      center: latlng,
      //scrollwheel: false,
      disableDoubleClickZoom: true,
      scaleControl: false,
      //zoomControl : false,
      streetViewControl : false,
      mapTypeId: google.maps.MapTypeId.ROADMAP
    };
    var map = new google.maps.Map(document.getElementById("map"), opts);
    var markers = [];
    var features = [];
    var busData;
    var overlay;

    function projectPoint(x, y) {
      var point = map.latLngToLayerPoint(new L.LatLng(y, x));
      this.stream.point(point.x, point.y);
    }


    map.data.addListener('click', function(e) {
    });

    $('#selRoute').select2({
      width: '300px' ,
      dropdownAutoWidth: true
    });
    function getBusInfo(operationCompany, callback) {
      $.get(
        '/bus_data/json/get_bus_data',
        {
          operationCompany : operationCompany
        },
        function (res) {
          callback(null, res);
        },
        'json'
      ).error(function(e){
        callback(e, null);
      });
    }
    showBlockUI();
    getBusInfo('草津市', function(err, res) {
      busData = res;
      $.unblockUI();
      console.log(err, res);
      $('#selRoute').empty();
      $('#selRoute').append($('<option>').html('').val(''));
      for (var i in busData) {
        console.log(i);
        var opt = $('<option>').html(busData[i].routeName).val(i);
        $('#selRoute').append(opt);
      }
    });

    var styleFeature = function() {
      return function(feature) {
        console.log(feature);
        return {
          strokeWeight : 1,
          strokeColor : '#FF0000',
          fillColor: '#FF0000',
          fillOpacity: 1
        };
      };
    }

    $('#selRoute').change(function() {
      var v = $('#selRoute').val();
      if (!v) {
        return;
      }
      
      var data = busData[v];
      var geom = JSON.parse(data.geometry);
      var geojson =         {
          'type': 'FeatureCollection',
          'features': [
            {
              'type': 'Feature',
              'properties': {routeid: v},
              'geometry': geom
            }
          ]
        };
      var pos = new google.maps.LatLng(geom.coordinates[0][1], geom.coordinates[0][0]);
      console.log(geom.coordinates[0][1], geom.coordinates[0][0]);
      map.panTo(pos);
      if (overlay) {
        overlay.setMap(null);
      }
      overlay = new google.maps.OverlayView();
      overlay.onAdd = function() {
        console.log('onAdd');
        var layer = d3.select(this.getPanes().overlayLayer).append("div").attr("class", "SvgOverlay");
        var svg = layer.append("svg");
        this.layer = layer;
        var roadLayer = svg.append("g").attr("class", "road_grp");
        this.roadLayer =roadLayer;
        var markerOverlay = this;
        var overlayProjection = markerOverlay.getProjection();
        console.log(roadLayer);
        //Google Projection作成
        var googleMapProjection = function (coordinates) {
          var googleCoordinates = new google.maps.LatLng(coordinates[1], coordinates[0]);
          var pixelCoordinates = overlayProjection.fromLatLngToDivPixel(googleCoordinates);
          return [pixelCoordinates.x + 4000, pixelCoordinates.y + 4000];
        };

        var filter = roadLayer.append("defs")
                        .append("filter")
                        .attr("id", "blur");
        filter.append("svg:feGaussianBlur")
              .attr("in", "SourceGraphic")
              .attr("stdDeviation", 2)
              .attr("result", "blur")
              ;

         var path = d3.geo.path().projection(googleMapProjection);
         console.log(geojson.features);
         overlay.draw = function () {
           console.log('draw');
           roadLayer.selectAll('path').remove();
           roadLayer.selectAll('.marker').remove();

           //地図描く
           roadLayer.selectAll("path")
             .data(geojson.features)
             .attr("d", path) 
             .enter().append("svg:path")
               .attr("d", path)
               .attr("class", "road")
               .attr("fill", "none");
              d3.selectAll('.road').each(function(n) {
                console.log(n);
                var self = this;
                var marker = roadLayer.append("circle")
                  .attr({
                    r: 10,
                    fill: 'red',
                    filter: 'url(#blur)',
                    transform: function () {
                      var p = self.getPointAtLength(0);
                      return "translate(" + [p.x, p.y] + ")";
                    }
                  });
                setTransition(marker, self);
              });
              
            function setTransition(m, pathNode) {
              var pathLength = pathNode.getTotalLength();
              function repeat() {
                m.transition()
                  .duration(5000)
                  .attr("class", "marker")
                  .each('end' , repeat)
                  .ease("linear")
                  .attrTween("transform", function (d, i) {
                    return function (t) {
                      var p = pathNode.getPointAtLength(pathLength*t);
                      return "translate(" + [p.x, p.y] + ")";
                    }
                  }
                );
              }
              repeat();
            }
         };
      };
      overlay.onRemove = function() {
        console.log('onremove');
        this.layer.remove();
      };
      overlay.setMap(map);
      /*
      for (var i = 0; i < features.length; i++) {
        map.data.remove(features[i]);
      }
      features = map.data.addGeoJson(
        {
          'type': 'FeatureCollection',
          'features': [
            {
              'type': 'Feature',
              'properties': {routeid: v},
              'geometry': geom
            }
          ]
        }
      );
      map.data.setStyle(styleFeature());
      console.log(data);
      */
    });
  });
});

</script>
</body>
</html>
