<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="ja">
<head>
  <title>バス路線データ</title>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="js/jquery/jquery-ui.min.css" type="text/css" />
  <link rel="stylesheet" href="js/select2/select2.css" type="text/css" />
  <link rel="stylesheet" href="base.css" type="text/css" />
  <style type="text/css">
  #map {
  }

  .SvgOverlay {
  }

  .SvgOverlay svg {
    position: absolute;
    top: -4000px;
    left: -4000px;
    width: 8000px;
    height: 8000px;        
  }

  .SvgOverlay path {
    stroke: black;
    stroke-width: 1px;
    fill-opacity: .6;
  }
  </style>
  <script type="text/javascript" src="js/async/lib/async.js"></script>
  <script type="text/javascript" src="js/jquery/jquery-1.11.1.min.js"></script>
  <script type="text/javascript" src="js/jquery/jquery-ui-1.10.4.min.js"></script>
  <script type="text/javascript" src="js/d3/d3.min.js"></script>
  <script type="text/javascript" src="js/blockui/jquery.blockUI.js"></script>
  <script type="text/javascript" src="js/select2/select2.min.js"></script> 
  <script type="text/javascript" src="js/jsrender/jsrender.min.js"></script> 
  <script src="https://maps.googleapis.com/maps/api/js?v=3.exp"></script>
  <script type="text/javascript" src="js/util.js"></script>

  <script id="tmplBusStop" type="text/x-jsrender">
    <p><b>{{:name}}</b></p>
    <p>停車順：
      {{for order}}
        {{:}}
      {{/for}}
    </p>
    <p>平日：
    {{for timetableWeekday}}
      {{:}} 
    {{/for}}
    </p>
    <p>土曜：
    {{for timetableSutday}}
      {{:}} 
    {{/for}}
    </p>
    <p>休日：
    {{for timetableHolykday}}
      {{:}} 
    {{/for}}
    </p>
  </script>
</head>
<body>
  <div id="contents">
    <h1>バスのオープンデータ</h1>
    <div>ルートを表示後、バス停をクリックすると時刻表がでます。</div>
    <div id = "left_area">
      <div>
        <select id="selRoute" multiple="true"></select>
        <button id="btn_show">ルート表示</button>
      </div>
      <div>
        <p>時刻表</p>
        <div id="time_table"></div>
      </div>
    </div>
    <div id = "main_area">
      <div id="map" style="width: 900px; height: 600px"></div>
    </div>
    <div  style="clear:both;"></div>
    <div id="meta"></div>
  </div>
<script type="text/javascript">

$(function() {
  /**
   * ローディング画面の表示
   */
  function showBlockUI() {
    $.blockUI(
      { 
        message: '<img src="img/loading.gif" />Loading...',
        css: { 
          border: 'none', 
          padding: '15px', 
          backgroundColor: '#444', 
          '-webkit-border-radius': '10px', 
          '-moz-border-radius': '10px', 
          opacity: .5, 
          color: '#fff' 
        } 
      }
    );
  }

  $(document).ready(function() {
    var latlng = new google.maps.LatLng(35.02231309126647,135.9622116936153);
    var opts = {
      zoom: 13,
      center: latlng,
      //scrollwheel: false,
      disableDoubleClickZoom: true,
      scaleControl: false,
      //zoomControl : false,
      streetViewControl : false,
      mapTypeId: google.maps.MapTypeId.ROADMAP
    };
    var map = new google.maps.Map(document.getElementById("map"), opts);
    var markers = [];
    var features = [];
    var busData;
    var overlay;

    function projectPoint(x, y) {
      var point = map.latLngToLayerPoint(new L.LatLng(y, x));
      this.stream.point(point.x, point.y);
    }


    map.data.addListener('click', function(e) {
    });

    $('#selRoute').select2({
      width: '300px' ,
      dropdownAutoWidth: true
    });
    function getBusInfo(dataName, callback) {
      $.get(
        '/bus_data/json/get_bus_data',
        {
          dataName : dataName
        },
        function (res) {
          callback(null, res);
        },
        'json'
      ).error(function(e){
        callback(e, null);
      });
    }
    showBlockUI();
    getBusInfo('まめバス', function(err, res) {
      busData = res['routes'];
      metaData = res['meta'];
      $.unblockUI();
      console.log(err, res);
      $('#selRoute').empty();
      $('#selRoute').append($('<option>').html('').val(''));
      for (var i in busData) {
        var opt = $('<option>').html(busData[i].routeName).val(i);
        $('#selRoute').append(opt);
        $('#meta').empty();
        $('#meta').append(
          '<p>このデータは「' + metaData.dataName + '」により作成されています。</p>' +
          '<p>作成者:' + metaData.author + '</p>' +
          '<p>ライセンス:' + metaData.license + '</p>' +
          '<p>URL:<a href ="' + metaData.url + '">' + metaData.url +'</a></p>' 
        );
      }
    });

    var styleFeature = function() {
      return function(feature) {
        return {
          strokeWeight : 1,
          strokeColor : '#FF0000',
          fillColor: '#FF0000',
          fillOpacity: 1
        };
      };
    }
    function createMarker(bskey, bs, data) {
      var pos = new google.maps.LatLng(bs.lat, bs.long);
      var marker = new google.maps.Marker({
        icon: 'img/busstop.png'
      });
      marker.setPosition(pos);
      marker.setMap(map);
      google.maps.event.addListener(marker, 'click', function() {
        $('#time_table').empty();
        var timetableWeekday = [];
        var timetableSutday = [];
        var timetableHolykday = [];
        var order = [];
        for (var i = 0; i < data.BusStopOrder.length; ++i) {
          if (data.BusStopOrder[i].busStopId == bskey) {
            order.push(data.BusStopOrder[i].order);
          }
        }
        console.log(bskey, data.BusStopOrder, order);
        for (var i in data.TimeTable) {
          var tm = data.TimeTable[i];
          console.log(tm);
          for (var j = 0; j < tm.table.length; ++j) {
            var t = tm.table[j];
            if (t.busStopId != bskey) {
              continue;
            }
            if (tm.dateType == 0) {
              timetableWeekday.push(t.time);
            } else if (tm.dateType == 1) {
              timetableSutday.push(t.time);
            } else {
              timetableHolykday.push(t.time);
            }
          }
        }
        console.log(timetableWeekday);
        var c = $('#tmplBusStop').render({
          name: bs.stopName,
          order: order,
          timetableWeekday: timetableWeekday,
          timetableSutday: timetableSutday,
          timetableHolykday: timetableHolykday
        });
        $('#time_table').append(c);
        /*
        var infowindow = new google.maps.InfoWindow({
          content: bs.stopName
        });
        infowindow.open(map, marker);
        */
      });
      return marker;
    }
    function showRoute(geojson) {

      overlay = new google.maps.OverlayView();
      overlay.onAdd = function() {
        var layer = d3.select(this.getPanes().overlayLayer).append("div").attr("class", "SvgOverlay");
        var svg = layer.append("svg");
        this.layer = layer;
        var roadLayer = svg.append("g").attr("class", "road_grp");
        this.roadLayer =roadLayer;
        var markerOverlay = this;
        var overlayProjection = markerOverlay.getProjection();
        //Google Projection作成
        var googleMapProjection = function (coordinates) {
          var googleCoordinates = new google.maps.LatLng(coordinates[1], coordinates[0]);
          var pixelCoordinates = overlayProjection.fromLatLngToDivPixel(googleCoordinates);
          return [pixelCoordinates.x + 4000, pixelCoordinates.y + 4000];
        };

        var filter = roadLayer.append("defs")
                        .append("filter")
                        .attr("id", "blur");
        filter.append("svg:feGaussianBlur")
              .attr("in", "SourceGraphic")
              .attr("stdDeviation", 2)
              .attr("result", "blur")
              ;

         var path = d3.geo.path().projection(googleMapProjection);
         overlay.draw = function () {
           roadLayer.selectAll('path').remove();
           roadLayer.selectAll('.marker').remove();

           //地図描く
           roadLayer.selectAll("path")
             .data(geojson.features)
             .attr("d", path) 
             .enter().append("svg:path")
               .attr("d", path)
               .attr("class", "road")
               .attr("fill", "none");
              d3.selectAll('.road').each(function(n) {
                var self = this;
                var marker = roadLayer.append("circle")
                  .attr({
                    r: 10,
                    fill: 'red',
                    filter: 'url(#blur)',
                    transform: function () {
                      var p = self.getPointAtLength(0);
                      return "translate(" + [p.x, p.y] + ")";
                    }
                  });
                setTransition(marker, self);
              });
              
            function setTransition(m, pathNode) {
              var pathLength = pathNode.getTotalLength();
              function repeat() {
                m.transition()
                  .duration(5000)
                  .attr("class", "marker")
                  .each('end' , repeat)
                  .ease("linear")
                  .attrTween("transform", function (d, i) {
                    return function (t) {
                      var p = pathNode.getPointAtLength(pathLength*t);
                      return "translate(" + [p.x, p.y] + ")";
                    }
                  }
                );
              }
              repeat();
            }
         };
      };
      overlay.onRemove = function() {
        this.layer.remove();
      };
      overlay.setMap(map);
    }
    $('#btn_show').button().click(function() {
      if (overlay) {
        overlay.setMap(null);
      }
      for (var i = 0; i < markers.length; ++i) {
        markers[i].setMap(null);
      }
      var selects = $('#selRoute').val();
      if (!selects) {
        return;
      }
      var geojson = {
        'type': 'FeatureCollection',
        'features': []
      };
      selects.forEach(function(v) {
        var data = busData[v];
        var geom = JSON.parse(data.geometry);
        var pos = new google.maps.LatLng(geom.coordinates[0][1], geom.coordinates[0][0]);
        map.panTo(pos);
        geojson.features.push(geom);
        for (var key in data.BusStop) {
          var bs = data.BusStop[key];
          markers.push(createMarker(key, bs, data));
        }
      });
      showRoute(geojson);
    });
  });
});

</script>
</body>
</html>
